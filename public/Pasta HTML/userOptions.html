<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlashMind - Configurações</title>

<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="../imgs/brain.ico">

<!-- Tailwind & FontAwesome -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

<style>
/* Reaproveitando estilos da página principal */
.gradient-text { background: linear-gradient(135deg, #3B82F6, #8B5CF6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.card-hover { transition: all 0.3s ease; }
.card-hover:hover { transform: translateY(-2px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
.animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
/* Dark Theme e scrollbar */
.dark { background-color: #0f172a; color: #f1f5f9; }
/* ... você pode copiar o resto do CSS da dashboard ... */
</style>
</head>

<body class="bg-slate-50 text-slate-900 font-sans min-h-screen">
<!-- Sidebar -->
    <aside class="fixed left-0 top-0 w-64 h-full bg-white border-r border-slate-200 flex flex-col z-40 overflow-y-auto sidebar-scroll">
        <div class="p-6 border-b border-slate-200">
                    <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg flex items-center justify-center">
                    <i class="fa-solid fa-brain text-white text-xl"></i>
                      </div>
                      <div>
                    <span class="text-xl font-semibold text-slate-900">FlashMind</span>
                    <p class="text-xs text-slate-500" id="profile-name">Pesquisador Acadêmico</p>
            </div>
          </div>
        </div>

        <nav class="flex-1 p-4 space-y-4 overflow-y-auto">
            <!-- Dashboard Section -->
            <div class="space-y-1">
                <div class="flex items-center space-x-2 px-3 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                    <i class="fas fa-home w-3"></i>
                    <span>Dashboard</span>
        </div>
                <a href="dashboard.html" class="flex items-center space-x-3 px-3 py-2 rounded-lg">
                    <i class="fas fa-chart-pie w-4"></i>
                    <span class="text-sm font-medium">Visão Geral</span>
                </a>
      </div>

            <!-- Documents Section -->
            <div class="space-y-1">
                <div class="flex items-center space-x-2 px-3 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                    <i class="fas fa-user w-4 h-4"></i>
                    <span>Usuário</span>
            </div>
                <a href="userOptions.html" class="flex items-center space-x-3 px-3 py-2 rounded-lg bg-blue-50 text-blue-600 border border-blue-200">
                    <i class="fas fa-cog w-4 h-4"></i>
                    <span class="text-sm">Opções</span>
                </a>
                <a href="foldersView.html" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors">
                    <i class="fas fa-folder w-4"></i>
                    <span class="text-sm">Minhas Pastas</span>
                </a>
            </div>

            <!-- AI & OCR Section -->
            <div class="space-y-1">
                <div class="flex items-center space-x-2 px-3 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                    <i class="fas fa-robot w-3"></i>
                    <span>IA & OCR</span>
              </div>
                <a href="#" onclick="openOCRModal()" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors">
                    <i class="fas fa-camera w-4"></i>
                    <span class="text-sm">Digitalizar</span>
                </a>
            </div>

            <!-- Tools Section -->
            <div class="space-y-1">
                <div class="flex items-center space-x-2 px-3 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                    <i class="fas fa-tools w-3"></i>
                    <span>Ferramentas</span>
                </div>
        </div>

            <!-- Help Section -->
            <div class="space-y-1">
                <div class="flex items-center space-x-2 px-3 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                    <i class="fas fa-question-circle w-3"></i>
                    <span>Ajuda</span>
          </div>
                <a href="guia.html" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors">
                    <i class="fas fa-book w-4"></i>
                    <span class="text-sm">Guia</span>
                </a>
                <a href="contato.html" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors">
                    <i class="fas fa-headset w-4"></i>
                    <span class="text-sm">Suporte</span>
                </a>
                <a href="sobre.html" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-colors">
                    <i class="fas fa-info-circle w-4"></i>
                    <span class="text-sm">Sobre</span>
                </a>
          </div>
          
          </nav>
        
        <div class="p-4 border-t border-slate-200 mt-auto">
            <div class="flex items-center space-x-3 mb-4">
                <div id="profile-icon" class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-white text-sm"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-900" id="user-role">Pesquisador</p>
                    <p class="text-xs text-slate-500">Ativo</p>
                </div>
              </div>
            <button onclick="logout()" class="w-full bg-slate-100 text-slate-600 hover:bg-slate-200 py-2 px-3 rounded-lg transition-colors text-sm">
                <i class="fas fa-sign-out-alt mr-2"></i>
                Sair
            </button>
               </div>
    </aside>


<!-- Main Content -->
<main class="ml-64 p-8 animate-fade-in">
    <h1 class="text-3xl font-bold text-slate-900 mb-6">Configurações do Usuário</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Perfil -->
        <div class="bg-white rounded-xl border border-slate-200 p-6 card-hover">
            <h2 class="text-xl font-semibold text-slate-900 mb-4">Perfil</h2>
            <label class="block mb-2 text-sm font-medium text-slate-700">Nome</label>
            <input type="text" placeholder="Seu nome" class="w-full p-2 border border-slate-300 rounded-lg mb-4">

            <label class="block mb-2 text-sm font-medium text-slate-700">Email</label>
            <input type="email" placeholder="email@exemplo.com" class="w-full p-2 border border-slate-300 rounded-lg mb-4">

            <button class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition">
                Salvar Alterações
            </button>
        </div>

        <!-- Foto de Perfil -->
        <div class="bg-white rounded-xl border border-slate-200 p-6 card-hover flex flex-col items-center justify-center">
            <h2 class="text-xl font-semibold text-slate-900 mb-4">Foto de Perfil</h2>

            <!-- Preview da imagem -->
            <div id="profile-preview" class="w-24 h-24 rounded-full overflow-hidden border-2 border-blue-500 flex items-center justify-center mb-4 transition-all duration-300 hover:scale-105">
                <i class="fas fa-user text-2xl text-slate-400"></i>
            </div>

            <!-- Input customizado -->
            <label class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 py-2 px-4 rounded-lg flex items-center space-x-2 transition-colors text-sm mb-2">
                <i class="fas fa-upload"></i>
                <span>Escolher Imagem</span>
                <input type="file" id="profilePhotoInput" accept="image/*" class="hidden">
            </label>

            <!-- Botão de upload -->
            <button id="uploadPhotoBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition shadow-md hover:shadow-lg text-sm">
                Atualizar Foto
            </button>
        </div>

        <!-- Segurança -->
        <div class="bg-white rounded-xl border border-slate-200 p-6 card-hover">
            <h2 class="text-xl font-semibold text-slate-900 mb-4">Segurança</h2>
            <label class="block mb-2 text-sm font-medium text-slate-700">Senha Atual</label>
            <input type="password" placeholder="******" class="w-full p-2 border border-slate-300 rounded-lg mb-4">

            <label class="block mb-2 text-sm font-medium text-slate-700">Nova Senha</label>
            <input type="password" placeholder="Nova senha" class="w-full p-2 border border-slate-300 rounded-lg mb-4">

            <label class="block mb-2 text-sm font-medium text-slate-700">Confirmar Nova Senha</label>
            <input type="password" placeholder="Confirme a senha" class="w-full p-2 border border-slate-300 rounded-lg mb-4">

            <button class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition">
                Alterar Senha
            </button>
        </div>

        <!-- Preferências -->
        <div class="bg-white rounded-xl border border-slate-200 p-6 card-hover">
            <h2 class="text-xl font-semibold text-slate-900 mb-4">Preferências</h2>

            <label class="flex items-center mb-4">
                <input type="checkbox" class="mr-2">
                Ativar notificações por email
            </label>

            <label class="flex items-center mb-4">
                <input type="checkbox" class="mr-2">
                Receber notificações de sistema
            </label>

            <label class="flex items-center mb-4">
                <input type="checkbox" class="mr-2" id="darkModeToggle">
                Tema escuro
            </label>

            <button class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-lg transition">
                Salvar Preferências
            </button>
        </div>

        <!-- Deletar Usuário -->
        <button id="deleteUserBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg mt-4 transition">
            Deletar Conta
        </button>
    </div>
</main>

<script>
const userId = localStorage.getItem('userId');
const token = localStorage.getItem('token');
const apiUrl = 'http://localhost:3000';

// Carregar dados do usuário
async function loadUserProfile() {
    try {
        const res = await fetch(`${apiUrl}/user/${userId}`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            }
        });
        if (!res.ok) throw new Error("Erro ao buscar usuário");

        const data = await res.json();
        const user = data.user;

        document.getElementById('user-role').textContent = data.user.nickname;
        // Atualiza sidebar
        const profileIcon = document.getElementById('profile-icon');
        if (profileIcon) {
            profileIcon.innerHTML = `<img src="${user.img}" alt="Usuário" class="w-full h-full object-cover rounded-full">`;
        }

        // Atualiza preview de foto
        const profilePreview = document.getElementById('profile-preview');
        if (profilePreview) {
            profilePreview.innerHTML = `<img src="${user.img}" alt="Usuário" class="w-full h-full object-cover">`;
        }

        // Preenche campos de perfil
        document.querySelector('input[type="text"]').value = user.nickname || '';
        document.querySelector('input[type="email"]').value = user.email || '';

    } catch (err) {
        console.error("Erro ao carregar usuário:", err.message);
    }
}

// Salvar alterações de nome/email
document.querySelector('.bg-blue-500').addEventListener('click', async () => {
    const nickname = document.querySelector('input[type="text"]').value.trim();
    const email = document.querySelector('input[type="email"]').value.trim();

    if (!nickname || !email) return alert("Preencha todos os campos");

    try {
        const res = await fetch(`${apiUrl}/user/${userId}/nameAndEmailUpdate`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ nickname, email })
        });

        const data = await res.json();
        if (res.ok) {
            alert("Perfil atualizado com sucesso!");
            loadUserProfile(); // Atualiza sidebar
        } else {
            alert(data.msg || "Erro ao atualizar perfil");
        }
    } catch (err) {
        console.error(err);
        alert("Erro ao atualizar perfil");
    }
});

// Alterar senha
document.querySelector('.bg-green-500').addEventListener('click', async () => {
    const currentPassword = document.querySelector('input[placeholder="******"]').value;
    const newPassword = document.querySelector('input[placeholder="Nova senha"]').value;
    const confirmPassword = document.querySelector('input[placeholder="Confirme a senha"]').value;

    if (!currentPassword || !newPassword || !confirmPassword) return alert("Preencha todos os campos");
    if (newPassword !== confirmPassword) return alert("A nova senha não coincide com a confirmação");

    try {
        const res = await fetch(`${apiUrl}/user/${userId}/passwordReset`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ currentPassword, newPassword })
        });

        const data = await res.json();
        if (res.ok) {
            alert("Senha alterada com sucesso!");
            document.querySelector('input[placeholder="******"]').value = '';
            document.querySelector('input[placeholder="Nova senha"]').value = '';
            document.querySelector('input[placeholder="Confirme a senha"]').value = '';
        } else {
            alert(data.msg || "Erro ao alterar senha");
        }
    } catch (err) {
        console.error(err);
        alert("Erro ao alterar senha");
    }
});

// Upload de foto
const profilePhotoInput = document.getElementById('profilePhotoInput');
const profilePreview = document.getElementById('profile-preview');
const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');

profilePhotoInput.addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        profilePreview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-full">`;
    };
    reader.readAsDataURL(file);
});

uploadPhotoBtn.addEventListener('click', async () => {
    const file = profilePhotoInput.files[0];
    if (!file) return alert("Escolha uma imagem primeiro!");
    const reader = new FileReader();
    reader.onload = async e => {
        const base64Img = e.target.result;
        try {
            const res = await fetch(`${apiUrl}/user/photo/${userId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ base64Img })
            });
            const data = await res.json();
            if (res.ok) {
                alert("Foto atualizada com sucesso!");
                document.getElementById('profile-icon').innerHTML = `<img src="${base64Img}" alt="Usuário" class="w-full h-full object-cover rounded-full">`;
            } else {
                alert(data.msg || "Erro ao atualizar foto");
            }
        } catch (err) {
            console.error(err);
            alert("Erro ao enviar imagem");
        }
    };
    reader.readAsDataURL(file);
});

document.getElementById('deleteUserBtn').addEventListener('click', async () => {
    const password = prompt("Para deletar sua conta, digite sua senha:");

    if (!password) return alert("Senha é obrigatória para deletar a conta!");

    if (!confirm("Tem certeza que deseja deletar sua conta? Esta ação é irreversível!")) return;

    try {
        const res = await fetch(`${apiUrl}/user/${userId}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ password })
        });

        const data = await res.json();
        if (res.ok) {
            alert("Conta deletada com sucesso!");
            logout(); // Desloga o usuário
        } else {
            alert(data.msg || "Erro ao deletar conta");
        }
    } catch (err) {
        console.error(err);
        alert("Erro ao processar a deleção");
    }
});


// Logout
function logout() {
    localStorage.clear();
    window.location.href = 'login.html';
}

// Dark mode toggle
const darkToggle = document.getElementById('darkModeToggle');
darkToggle?.addEventListener('change', () => {
    document.body.classList.toggle('dark');
});

document.addEventListener('DOMContentLoaded', loadUserProfile);
</script>

</body>
</html>
