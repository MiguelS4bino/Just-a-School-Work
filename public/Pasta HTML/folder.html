<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlashMind - Pasta</title>
<link rel="icon" type="image/x-icon" href="../imgs/brain.ico">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
    .gradient-text {
        background: linear-gradient(135deg, #3B82F6, #8B5CF6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .card-hover {
        transition: all 0.3s ease;
    }
    .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .notes-card { width: 100%; }
</style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans min-h-screen">

<!-- HEADER -->
<header class="fixed top-0 left-0 right-0 z-50 py-4 px-6 md:px-12 flex items-center justify-between bg-white/80 backdrop-blur-sm border-b border-slate-200">
  <div class="flex items-center space-x-3">
    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg flex items-center justify-center">
      <i class="fa-solid fa-brain text-white text-xl"></i>
    </div>
    <span class="text-2xl font-bold text-slate-900">FlashMind</span>
  </div>
  <nav class="hidden md:flex items-center space-x-8">
    <a href="dashboard.html" class="text-slate-600 hover:text-slate-900 transition-colors">Dashboard</a>
    <a href="foldersView.html" class="text-slate-600 hover:text-slate-900 transition-colors">Documentos</a>
    <a href="#" class="text-blue-600 font-medium">Pasta</a>
  </nav>
</header>

<!-- MAIN -->
<main class="pt-24 pb-16 px-6 md:px-12 min-h-[calc(100vh-6rem)]">
  <div class="max-w-5xl mx-auto">
    <!-- Header da pasta -->
    <div id="folderHeader" class="mb-8">
      <h1 class="text-3xl font-bold text-slate-900 mb-2">Carregando...</h1>
      <p class="text-slate-600">Aguarde enquanto os dados são carregados</p>
    </div>

    <!-- Texto Relacionado -->
    <div id="relacionedTextContainer" class="bg-white rounded-xl p-4 shadow mb-6 hidden relative">
      <div id="relacionedHeader" class="flex justify-between items-center cursor-pointer">
        <h2 class="text-lg font-semibold mb-0">Texto Relacionado</h2>
        <span class="text-gray-400 text-sm">Clique para expandir</span>
      </div>
      <p id="relacionedText" class="text-gray-700 mt-2 hidden whitespace-pre-line"></p>
    </div>

    <!-- Botões -->
    <div class="flex items-center gap-4 mb-8">
      <button id="newNoteButton" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-5 py-2 rounded-lg hover:shadow-lg transition-all duration-300">
        <i class="fas fa-plus mr-2"></i> Nova Nota
      </button>
      <button onclick="window.location.href='foldersView.html'" class="border border-slate-300 text-slate-700 px-5 py-2 rounded-lg hover:bg-slate-50 transition-all duration-300">
        <i class="fas fa-arrow-left mr-2"></i> Voltar
      </button>
    </div>

    <!-- Barra de pesquisa -->
    <div class="mb-6">
    <input 
        type="text" 
        id="searchNotes" 
        placeholder="Pesquisar notas..." 
        class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
    </div>

    <!-- Notas -->
    <div id="notesContainer" class="grid grid-cols-1 gap-3">
      <div class="flex justify-center items-center h-40 text-slate-600">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mr-4"></div>
        Carregando notas...
      </div>
    </div>
  </div>
</main>

<!-- MODAL Nova Nota -->
<div id="createNoteModal" class="fixed inset-0 flex bg-black/40 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl w-full max-w-lg p-6 relative">
    <button id="closeCreateNoteModal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
      <i class="fas fa-times"></i>
    </button>
    <h2 class="text-xl font-semibold text-slate-900 mb-4">Criar Nova Nota</h2>

    <input type="text" id="noteTitle" placeholder="Título da nota" class="w-full border border-slate-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">

    <div id="noteItemsContainer" class="space-y-2 mb-4">
      <input type="text" class="note-item w-full border border-slate-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite um tópico...">
    </div>

    <button id="addNoteItem" class="text-blue-600 text-sm mb-4 hover:underline">+ Adicionar tópico</button>

    <div class="flex justify-end space-x-4">
      <button id="cancelCreateNote" class="px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 transition-all">Cancelar</button>
      <button id="confirmCreateNote" class="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500 text-white hover:shadow-lg transition-all">Criar</button>
    </div>
  </div>
</div>

<!-- MODAL Upload -->
<div id="uploadModal" class="fixed inset-0 flex bg-black/40 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl w-full max-w-lg p-6 relative">
    <button id="closeUploadModal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
      <i class="fas fa-times"></i>
    </button>
    <h2 class="text-xl font-semibold text-slate-900 mb-4">Adicionar Arquivos/Imagens</h2>

    <input type="file" id="uploadFiles" multiple class="mb-4" />

    <div class="flex justify-end space-x-4">
      <button id="cancelUpload" class="px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 transition-all">Cancelar</button>
      <button id="confirmUpload" class="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500 text-white hover:shadow-lg transition-all">Enviar</button>
    </div>
  </div>
</div>

<script>
const token = localStorage.getItem("token");
if (!token) window.location.href = "login.html";

const userId = localStorage.getItem('userId');
const folderId = new URLSearchParams(window.location.search).get("id");

const folderHeader = document.getElementById("folderHeader");
const notesContainer = document.getElementById("notesContainer");
const textContainer = document.getElementById("relacionedTextContainer");
const textContent = document.getElementById("relacionedText");
const textHeader = document.getElementById("relacionedHeader");

let folder = null;

async function loadFolder() {
  try {
    const res = await fetch(`http://localhost:3000/Folder/${folderId}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!res.ok) throw new Error("Erro ao carregar pasta");

    folder = await res.json();
    renderFolder(folder);
  } catch (err) {
    console.error(err);
    folderHeader.innerHTML = `<h1 class="text-3xl font-bold text-red-500">Erro ao carregar pasta</h1>`;
  }
}

function renderFolder(folder) {
  folderHeader.innerHTML = `
    <h1 class="text-3xl font-bold text-slate-900 mb-1">${folder.title}</h1>
    <p class="text-slate-600">Criada em ${new Date(folder.createdAt).toLocaleDateString('pt-BR')}</p>
    <p class="text-slate-500 mt-2">${folder.extractedItems?.length || 0} nota(s)</p>
  `;

  textContainer.classList.remove("hidden");
  textContent.textContent = folder.relacionedText || "Sem texto relacionado.";
  textContent.classList.add("hidden");

  textHeader.onclick = () => textContent.classList.toggle("hidden");
  renderNotes(folder.extractedItems || []);
}

function renderNotes(notes) {
  notesContainer.innerHTML = '';

  if (!notes.length) {
    notesContainer.innerHTML = `
      <div class="col-span-full text-center py-16 text-slate-500">
        <i class="fas fa-sticky-note text-6xl text-slate-300 mb-4"></i>
        <p>Nenhuma nota encontrada. Crie uma nova!</p>
      </div>`;
    return;
  }

  const itemsList = document.createElement('ul');
  itemsList.className = "list-disc list-inside text-slate-700 mt-3 space-y-1 max-h-0 overflow-hidden transition-all duration-300";

  notes.forEach(note => {
    const card = document.createElement('div');
    card.className = "bg-white border border-slate-200 rounded-xl p-5 shadow-sm card-hover notes-card";

    // Header: Título, data e ações
    const header = document.createElement('div');
    header.className = "flex items-center cursor-pointer";

    const titleContainer = document.createElement('div');
    titleContainer.className = "flex flex-col";
    titleContainer.innerHTML = `
      <h3 class="text-lg font-semibold text-slate-900">${note.title}</h3>
      <span class="text-gray-400 text-sm">${new Date(note.createdAt).toLocaleDateString('pt-BR')}</span>
    `;
    titleContainer.querySelector('h3').onclick = () => enableInlineRenameNote(note._id, titleContainer.querySelector('h3'));

    const actions = document.createElement('div');
    actions.className = "flex gap-3 ml-auto";

    // Botão Upload
    const uploadBtn = document.createElement('button');
    uploadBtn.className = "ml-2 text-blue-600 hover:underline text-sm";
    uploadBtn.textContent = "Adicionar arquivos";
    uploadBtn.onclick = () => openUploadModal(note._id);
    actions.appendChild(uploadBtn);

    // Botão Deletar
    const deleteBtn = document.createElement('button');
    deleteBtn.className = "delete-note hover:text-red-500";
    deleteBtn.title = "Excluir";
    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
    actions.appendChild(deleteBtn);

    header.append(titleContainer, actions);

    // Eventos dos botões
    deleteBtn.onclick = async (e) => {
      e.stopPropagation();
      if (confirm("Deseja realmente deletar esta nota?")) {
        try {
          const res = await fetch(`http://localhost:3000/Note/${note._id}/delete`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
          });
          if (!res.ok) throw new Error("Erro ao apagar nota");
          loadFolder();
        } catch (err) {
          console.error(err);
          alert("Erro ao apagar nota");
        }
      }
    };

    // Containers de imagens e arquivos
    const imagesContainer = document.createElement('div');
    imagesContainer.className = "flex flex-wrap gap-2 mt-3 max-h-0 overflow-hidden transition-all duration-300";
    if (note.images?.length) {
      note.images.forEach(imgPath => {
        const img = document.createElement('img');
        img.src = `http://localhost:3000/${imgPath}`;
        img.alt = "Imagem da nota";
        img.className = "w-16 h-16 object-cover rounded-lg border border-slate-200 cursor-pointer hover:scale-105 transition-transform";
        img.onclick = () => window.open(img.src, "_blank");
        imagesContainer.appendChild(img);
      });
    }

    const filesContainer = document.createElement('div');
    filesContainer.className = "flex flex-col gap-1 mt-2 max-h-0 overflow-hidden transition-all duration-300";
    if (note.files?.length) {
      note.files.forEach(filePath => {
        const fileName = filePath.split('/').pop();
        const a = document.createElement('a');
        a.href = `http://localhost:3000/${filePath}`;
        a.target = "_blank";
        a.textContent = fileName;
        a.className = "text-blue-600 hover:underline text-sm";
        filesContainer.appendChild(a);
      });
    }

    // Lista de itens da nota
    const itemsList = document.createElement('ul');
    itemsList.className = "list-disc list-inside text-slate-700 mt-3 space-y-1 max-h-0 overflow-hidden transition-all duration-300";
    note.items.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      itemsList.appendChild(li);
    });

    // Toggle para expandir/contrair lista
    header.addEventListener("click", () => {
      const isExpanded = itemsList.style.maxHeight && itemsList.style.maxHeight !== "0px";
      const newMaxHeight = isExpanded ? "0px" : `${itemsList.scrollHeight + imagesContainer.scrollHeight + filesContainer.scrollHeight + 20}px`;

      itemsList.style.maxHeight = isExpanded ? "0px" : `${itemsList.scrollHeight}px`;
      imagesContainer.style.maxHeight = isExpanded ? "0px" : `${imagesContainer.scrollHeight}px`;
      filesContainer.style.maxHeight = isExpanded ? "0px" : `${filesContainer.scrollHeight}px`;
    });

    const addItemBtn = document.createElement("button");
    addItemBtn.textContent = "+ Adicionar item";
    addItemBtn.className = "text-blue-600 text-sm mt-2 hover:underline";
    addItemBtn.onclick = async () => {
        const noteNewItem = prompt("Digite o novo tópico:");
        if (!noteNewItem) return;
        try {
            const res = await fetch(`http://localhost:3000/Note/${note._id}/addItem`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ noteNewItem })
            });
            if (!res.ok) throw new Error("Erro ao adicionar item");
            loadFolder();
        } catch (err) {
            console.error(err);
            alert("Erro ao adicionar item");
        }
    };
    card.append(addItemBtn);

    // Append final na ordem: header → imagens → arquivos → lista
    card.append(header, imagesContainer, filesContainer, itemsList);
    notesContainer.appendChild(card);
  });
}

// Modal Nova Nota
const modal = document.getElementById("createNoteModal");
document.getElementById("newNoteButton").onclick = () => modal.classList.remove("hidden");
document.getElementById("closeCreateNoteModal").onclick = () => modal.classList.add("hidden");
document.getElementById("cancelCreateNote").onclick = () => modal.classList.add("hidden");

document.getElementById("addNoteItem").onclick = () => {
  const container = document.getElementById("noteItemsContainer");
  const input = document.createElement("input");
  input.type = "text";
  input.placeholder = "Digite um tópico...";
  input.className = "note-item w-full border border-slate-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500";
  container.appendChild(input);
};

document.getElementById("confirmCreateNote").onclick = async () => {
  const title = document.getElementById("noteTitle").value.trim();
  const items = [...document.querySelectorAll(".note-item")].map(i => i.value.trim()).filter(v => v);

  if (!title || !items.length) {
    alert("Preencha o título e pelo menos um tópico!");
    return;
  }

  try {
    const res = await fetch(`http://localhost:3000/Note/${folderId}/createNote`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify({ folderId, title, items })
    });
    if (!res.ok) throw new Error("Erro ao criar nota");

    modal.classList.add("hidden");
    loadFolder();
  } catch (err) {
    console.error(err);
    alert("Erro ao criar nota.");
  }
};

// Renomear nota
function enableInlineRenameNote(noteId, titleElem) {
    const originalText = titleElem.textContent.trim();

    const input = document.createElement("input");
    input.type = "text";
    input.value = originalText;
    input.className = "border border-slate-300 rounded px-2 py-1 w-full max-w-xs";
    titleElem.replaceWith(input);
    input.focus();
    input.select();

    const restoreOriginal = () => {
        const newTitleElem = document.createElement("h3");
        newTitleElem.className = "text-lg font-semibold text-slate-900";
        newTitleElem.textContent = originalText;
        input.replaceWith(newTitleElem);

        // Permitir clique para renomear novamente
        newTitleElem.onclick = () => enableInlineRenameNote(noteId, newTitleElem);
    };

    const saveRename = async () => {
        const newTitle = input.value.trim();
        if (!newTitle) return restoreOriginal();

        try {
            const res = await fetch(`http://localhost:3000/Note/${noteId}/rename`, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ newTitle })
            });

            if (!res.ok) throw new Error("Erro ao renomear nota");

            const newTitleElem = document.createElement("h3");
            newTitleElem.className = "text-lg font-semibold text-slate-900";
            newTitleElem.textContent = newTitle;
            input.replaceWith(newTitleElem);
            newTitleElem.onclick = () => enableInlineRenameNote(noteId, newTitleElem);
        } catch (err) {
            console.error(err);
            alert("Erro ao renomear nota");
            restoreOriginal();
        }
    };

    input.addEventListener("keydown", e => {
        if (e.key === "Enter") saveRename();
        if (e.key === "Escape") restoreOriginal();
    });

    input.addEventListener("blur", saveRename);
}

// Modal Upload de arquivos e imagens
    const uploadModal = document.getElementById("uploadModal");
    let currentNoteId = null;

    function openUploadModal(noteId) {
      currentNoteId = noteId;
      uploadModal.classList.remove("hidden");
    }

    //Upload Modal functions
    document.getElementById("closeUploadModal").onclick = () => uploadModal.classList.add("hidden");
    document.getElementById("cancelUpload").onclick = () => uploadModal.classList.add("hidden");

    document.getElementById("confirmUpload").onclick = async () => {
      const files = document.getElementById("uploadFiles").files;
      if (!files.length) {
        alert("Selecione pelo menos um arquivo.");
        return;
      }

      const formData = new FormData();
      for (let f of files) {
        const isImage = f.type.startsWith('image/');
        if (isImage) formData.append('images', f);
        else formData.append('files', f);
      }

      try {
        const res = await fetch(`http://localhost:3000/Note/${currentNoteId}/upload`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${token}` },
          body: formData
        });
        if (!res.ok) throw new Error("Erro ao enviar arquivos");

        uploadModal.classList.add("hidden");
        loadFolder(); // Recarrega notas com novos arquivos
      } catch (err) {
        console.error(err);
        alert("Erro ao enviar arquivos.");
      }
    };

const searchInput = document.getElementById("searchNotes");

searchInput.addEventListener("input", () => {
  const query = searchInput.value.toLowerCase();
  const filteredNotes = folder.extractedItems.filter(note => note.title.toLowerCase().includes(query));
  renderNotes(filteredNotes);
});

// Inicializa
loadFolder();
</script>
</body>
</html>
